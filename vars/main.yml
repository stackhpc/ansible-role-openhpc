---
# OpenHPC 2 on CentOS 8

ohpc_slurm_packages:
  control:
    - "ohpc-slurm-server"
    - "slurm-slurmctld-ohpc"
    - "slurm-example-configs-ohpc"
  batch:
    - "ohpc-base-compute"
    - "ohpc-slurm-client"
  runtime:
    - "slurm-ohpc"
    - "munge"
    - "slurm-slurmd-ohpc"
    - "slurm-example-configs-ohpc"
    - "{{ 'lmod-ohpc' if openhpc_module_system_install else '' }}"
  database:
    - "slurm-slurmdbd-ohpc"

openhpc_merged_config: "{{ openhpc_default_config | combine(openhpc_config) }}"

ohpc_nodegroups_computed: >
  {
  {% for nodegroup in openhpc_nodegroups %}
  {%  set inventory_group_name = openhpc_cluster_name ~ '_' ~ nodegroup.name %}
  {%  set inventory_group_hosts = groups.get(inventory_group_name, []) %}
  {%      if inventory_group_hosts | length > 0 %}
  {%          set play_group_hosts = inventory_group_hosts | intersect (play_hosts) %}
  {%          set first_host = play_group_hosts | first | mandatory('Inventory group "' ~ inventory_group_name ~ '" contains no hosts in this play - was --limit used?') %}
  {%          set first_host_hv = hostvars[first_host] %}
  {%          set ram_mb = (first_host_hv['ansible_memory_mb']['real']['total'] * (nodegroup.ram_multiplier | default(openhpc_ram_multiplier))) | int %}
      {{ nodegroup.name | to_json }}: {
          "inventory_group_name": {{ inventory_group_name | to_json }},
          "first_host": {{ first_host | to_json }},
          "ram_mb": {{ ram_mb }},
          "def_mem_per_cpu": {{ (ram_mb / first_host_hv['ansible_processor_vcpus']) | int }},
  {%         if 'gres' in nodegroup -%}
          "gres": {{ ','.join(nodegroup.gres | map(attribute='conf')) | to_json }},
  {%         elif nodegroup.gres_autodetect | default(openhpc_gres_autodetect) == 'nvml' and first_host_hv['ohpc_node_gpu_gres'] != '' -%}
          "gres": {{ first_host_hv['ohpc_node_gpu_gres'] | to_json }},
          {% endif %}
      },
  {%      endif %}
  {% endfor %}
  }

ohpc_accounting_storage_tres: >-
  {%- set tres =
      ohpc_nodegroups_computed.values()
      | selectattr('gres', 'defined') | map(attribute='gres')
      | map('regex_replace', ':[0-9]+(,|$)', '\\1')
      | map('split', ',')
      | flatten | sort | unique
      | map('regex_replace', '^', 'gres/')
      | join(',')
  -%}
  {# add the generic gres/gpu otherwise a job requesting `--gpus 1` or `--gres=gpu:1` will be assigned to a "random" gpu model #}
  {{ ('gres/gpu:' in tres and not tres is search('gres/gpu(,|$)')) | ternary('gres/gpu,' ~ tres, tres) }}

...
