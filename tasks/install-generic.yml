- include_tasks: pre.yml

- name: Create a list of slurm daemons
  set_fact:
    _ohpc_daemons: "{{ _ohpc_daemon_map | dict2items | selectattr('value') | items2dict | list }}"
  vars:
    _ohpc_daemon_map:
      slurmctld: "{{ openhpc_enable.control }}"
      slurmd: "{{ openhpc_enable.batch }}"
      slurmdbd: "{{ openhpc_enable.database }}"

- name: Ensure extra repos
  ansible.builtin.yum_repository: "{{ item }}" # noqa: args[module]
  loop: "{{ openhpc_extra_repos }}"
  loop_control:
    label: "{{ item.name }}"

- name: Install system packages
  dnf:
    name: "{{ openhpc_generic_packages }}"

- name: Create Slurm user
  user:
    name: slurm
    comment: SLURM resource manager
    home: /etc/slurm
    shell: /sbin/nologin

- name: Create Slurm unit files
  template:
    src: "{{ item }}.service.j2"
    dest: /lib/systemd/system/{{ item }}.service
    owner: root
    group: root
    mode: ug=rw,o=r
  loop: "{{ _ohpc_daemons }}"
  register: _slurm_systemd_units

- name: Get current library locations
  shell:
    cmd: "ldconfig -v | grep -v ^$'\t'" # noqa: no-tabs risky-shell-pipe
  register: _slurm_ldconfig
  changed_when: false

- name: Add library locations to ldd search path
  copy:
    dest: /etc/ld.so.conf.d/slurm.conf
    content: "{{ openhpc_lib_dir }}"
    owner: root
    group: root
    mode: ug=rw,o=r
  when: openhpc_lib_dir not in _ldd_paths
  vars:
    _ldd_paths: "{{ _slurm_ldconfig.stdout_lines | map('split', ':') | map('first') }}"

- name: Reload Slurm unit files
  # Can't do just this from systemd module
  command: systemctl daemon-reload # noqa: command-instead-of-module no-changed-when no-handler
  when: _slurm_systemd_units.changed

- name: Prepend $PATH with slurm user binary location
  lineinfile:
    path: /etc/environment
    line: "{{ new_path }}"
    regexp: "^{{ new_path | regex_escape }}"
    owner: root
    group: root
    mode: u=gw,go=r
  vars:
    new_path: PATH="{{ openhpc_bin_dir }}:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin"

- meta: reset_connection # to get new environment
